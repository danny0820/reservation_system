# åŠŸèƒ½å°èˆª - ä½¿ç”¨è€…ç®¡ç† API

> æœ¬æª”æ¡ˆè¨˜éŒ„å°ˆæ¡ˆä¸­å·²å¯¦ç¾çš„æ‰€æœ‰é¡åˆ¥ã€æ–¹æ³•å’ŒåŠŸèƒ½ï¼Œæ–¹ä¾¿å¿«é€Ÿäº†è§£ç¾æœ‰åŠŸèƒ½

---

## ğŸ“‚ å°ˆæ¡ˆçµæ§‹æ¦‚è¦½

```
app/
â”œâ”€â”€ models/         # è³‡æ–™åº«æ¨¡å‹
â”œâ”€â”€ schemas/        # Pydantic è³‡æ–™é©—è­‰æ¨¡å‹
â”œâ”€â”€ crud/          # è³‡æ–™åº«æ“ä½œ
â”œâ”€â”€ routers/       # API è·¯ç”±
â”œâ”€â”€ auth.py        # èªè­‰ç›¸é—œåŠŸèƒ½
â”œâ”€â”€ database.py    # è³‡æ–™åº«é…ç½®
â””â”€â”€ core/
    â””â”€â”€ config.py  # æ‡‰ç”¨ç¨‹å¼é…ç½®
```

---

## ğŸ“‹ å·²å¯¦ç¾åŠŸèƒ½æ¸…å–®

### ğŸ—„ï¸ è³‡æ–™åº«æ¨¡å‹ (`app/models/user_models.py`)

#### `UserRole` (æšèˆ‰é¡)
- **ç”¨é€”**: å®šç¾©ä½¿ç”¨è€…è§’è‰²é¡å‹
- **å¯ç”¨è§’è‰²**:
  - `customer`: å®¢æˆ¶
  - `stylist`: è¨­è¨ˆå¸«
  - `admin`: ç®¡ç†å“¡

#### `User` (è³‡æ–™åº«æ¨¡å‹)
- **ç”¨é€”**: ä½¿ç”¨è€…è³‡æ–™è¡¨å°æ‡‰çš„ SQLAlchemy æ¨¡å‹
- **ä¸»è¦æ¬„ä½**:
  - `user_id`: ä½¿ç”¨è€…å”¯ä¸€è­˜åˆ¥ç¢¼
  - `username`: ä½¿ç”¨è€…åç¨±
  - `first_name`, `last_name`: å§“å
  - `role`: ä½¿ç”¨è€…è§’è‰²
  - `phone`: é›»è©±è™Ÿç¢¼
  - `email`: é›»å­éƒµä»¶
  - `password`: å¯†ç¢¼ï¼ˆå“ˆå¸Œï¼‰
  - `google_uid`, `line_uid`: ç¬¬ä¸‰æ–¹ç™»å…¥è­˜åˆ¥ç¢¼
  - `status`: ä½¿ç”¨è€…ç‹€æ…‹
  - `created_at`, `updated_at`: æ™‚é–“æˆ³è¨˜

---

### ğŸ“ è³‡æ–™é©—è­‰æ¶æ§‹ (`app/schemas/user_schemas.py`)

#### `UserBase` (åŸºç¤æ¨¡å‹)
- **ç”¨é€”**: ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™æ¬„ä½

#### `UserCreate` (å»ºç«‹ä½¿ç”¨è€…)
- **ç”¨é€”**: å»ºç«‹æ–°ä½¿ç”¨è€…æ™‚çš„è³‡æ–™é©—è­‰
- **ç¹¼æ‰¿**: `UserBase`
- **é¡å¤–æ¬„ä½**: `password`, `role`, `status`

#### `UserSignup` (ä½¿ç”¨è€…è¨»å†Š)
- **ç”¨é€”**: ä½¿ç”¨è€…è‡ªè¡Œè¨»å†Šæ™‚çš„è³‡æ–™é©—è­‰
- **ç‰¹é»**: ç°¡åŒ–ç‰ˆçš„ä½¿ç”¨è€…å»ºç«‹è¡¨å–®

#### `UserUpdate` (æ›´æ–°ä½¿ç”¨è€…)
- **ç”¨é€”**: æ›´æ–°ä½¿ç”¨è€…è³‡æ–™æ™‚çš„é©—è­‰
- **ç‰¹é»**: æ‰€æœ‰æ¬„ä½éƒ½æ˜¯å¯é¸çš„

#### `UserUpdatePassword` (å¯†ç¢¼æ›´æ–°)
- **ç”¨é€”**: æ›´æ–°å¯†ç¢¼å°ˆç”¨æ¨¡å‹
- **æ¬„ä½**: `current_password`, `new_password`

#### `UserResponse` (å›æ‡‰æ¨¡å‹)
- **ç”¨é€”**: API å›æ‡‰æ™‚çš„ä½¿ç”¨è€…è³‡æ–™æ ¼å¼
- **ç¹¼æ‰¿**: `UserBase`
- **é¡å¤–æ¬„ä½**: `user_id`, `role`, `status`, `created_at`, `updated_at`

#### `UserRoleAssignment` (è§’è‰²åˆ†é…)
- **ç”¨é€”**: ç®¡ç†å“¡åˆ†é…ä½¿ç”¨è€…è§’è‰²
- **æ¬„ä½**: `role`

#### `Token` & `TokenData` (ä»¤ç‰Œç›¸é—œ)
- **ç”¨é€”**: JWT ä»¤ç‰Œç›¸é—œçš„è³‡æ–™æ¨¡å‹

#### `UserStatusUpdate` (ç‹€æ…‹æ›´æ–°)
- **ç”¨é€”**: æ›´æ–°ç”¨æˆ¶ç‹€æ…‹çš„è«‹æ±‚æ¨¡å‹
- **æ¬„ä½**: `status`

#### `LinkedAccountsResponse` (é€£çµå¸³è™Ÿå›æ‡‰)
- **ç”¨é€”**: ç¬¬ä¸‰æ–¹å¸³è™Ÿé€£çµç‹€æ…‹çš„å›æ‡‰æ ¼å¼
- **åŠŸèƒ½**: é¡¯ç¤º Googleã€LINE ç­‰ç¬¬ä¸‰æ–¹å¸³è™Ÿé€£çµæƒ…æ³

#### `VerificationRequest` (é©—è­‰è«‹æ±‚)
- **ç”¨é€”**: ç™¼é€é©—è­‰ä¿¡çš„è«‹æ±‚æ¨¡å‹
- **æ¬„ä½**: `email`, `phone`

#### `PasswordResetRequest` (å¯†ç¢¼é‡ç½®è«‹æ±‚)
- **ç”¨é€”**: é‡ç½®å¯†ç¢¼çš„è«‹æ±‚æ¨¡å‹
- **æ¬„ä½**: `new_password`

---

### ğŸ”§ CRUD æ“ä½œ (`app/crud/user_crud.py`)

#### `UserCRUD` é¡
å®Œæ•´çš„ä½¿ç”¨è€…è³‡æ–™åº«æ“ä½œé¡ï¼Œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š

##### æŸ¥è©¢æ“ä½œ
- `get_user_by_id(db, user_id)`: æ ¹æ“š ID ç²å–ä½¿ç”¨è€…
- `get_user_by_username(db, username)`: æ ¹æ“šä½¿ç”¨è€…åç¨±ç²å–ä½¿ç”¨è€…
- `get_user_by_email(db, email)`: æ ¹æ“šé›»å­éƒµä»¶ç²å–ä½¿ç”¨è€…
- `get_users(db, skip, limit)`: ç²å–ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆåˆ†é ï¼‰

##### å»ºç«‹æ“ä½œ
- `create_user(db, user)`: å»ºç«‹æ–°ä½¿ç”¨è€…ï¼ˆé€šç”¨ï¼‰
- `create_customer(db, ...)`: å»ºç«‹å®¢æˆ¶ä½¿ç”¨è€…ï¼ˆç‰¹åŒ–ï¼‰

##### æ›´æ–°æ“ä½œ
- `update_user(db, user, user_update)`: æ›´æ–°ä½¿ç”¨è€…è³‡è¨Š
- `update_user_password(db, user, new_password)`: æ›´æ–°ä½¿ç”¨è€…å¯†ç¢¼
- `update_user_role(db, user, new_role)`: æ›´æ–°ä½¿ç”¨è€…è§’è‰²

##### åˆªé™¤æ“ä½œ
- `delete_user(db, user)`: åˆªé™¤ä½¿ç”¨è€…

##### é©—è­‰æ“ä½œ
- `is_username_taken(db, username)`: æª¢æŸ¥ä½¿ç”¨è€…åç¨±æ˜¯å¦å·²ä½¿ç”¨
- `is_email_taken(db, email)`: æª¢æŸ¥é›»å­éƒµä»¶æ˜¯å¦å·²ä½¿ç”¨

##### é€²éšæŸ¥è©¢æ“ä½œ
- `get_users_by_role(db, role, skip, limit)`: æ ¹æ“šè§’è‰²ç²å–ç”¨æˆ¶åˆ—è¡¨
- `get_users_by_status(db, status, skip, limit)`: æ ¹æ“šç‹€æ…‹ç²å–ç”¨æˆ¶åˆ—è¡¨

##### é€²éšç®¡ç†æ“ä½œ
- `update_user_status(db, user, status)`: æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
- `reset_user_password(db, user, new_password)`: é‡ç½®ç”¨æˆ¶å¯†ç¢¼
- `get_linked_accounts(db, user_id)`: ç²å–ç¬¬ä¸‰æ–¹å¸³è™Ÿé€£çµç‹€æ…‹

**å–®ä¾‹å¯¦ä¾‹**: `user_crud` - å¯ç›´æ¥ä½¿ç”¨çš„ UserCRUD å¯¦ä¾‹

---

### ğŸ›£ï¸ API è·¯ç”± (`app/routers/users.py`)

#### èªè­‰è·¯ç”±ï¼ˆç„¡éœ€èªè­‰ï¼‰
- `POST /login`: ä½¿ç”¨è€…ç™»å…¥ï¼Œè¿”å› JWT ä»¤ç‰Œ
- `POST /signup`: ä½¿ç”¨è€…è¨»å†Š

#### å€‹äººè³‡æ–™è·¯ç”±ï¼ˆéœ€è¦èªè­‰ï¼‰
- `GET /me`: ç²å–å€‹äººè³‡è¨Š
- `PATCH /me`: æ›´æ–°å€‹äººè³‡è¨Š
- `PATCH /me/password`: æ›´æ–°å€‹äººå¯†ç¢¼
- `DELETE /me`: åˆªé™¤å€‹äººå¸³è™Ÿ

#### ä½¿ç”¨è€…ç®¡ç†è·¯ç”±ï¼ˆç®¡ç†å“¡æ¬Šé™ï¼‰
- `GET /`: ç²å–æ‰€æœ‰ä½¿ç”¨è€…åˆ—è¡¨
- `POST /`: å»ºç«‹æ–°ä½¿ç”¨è€…
- `GET /{user_id}`: æ ¹æ“š ID ç²å–æŒ‡å®šä½¿ç”¨è€…
- `PATCH /{user_id}`: æ›´æ–°æŒ‡å®šä½¿ç”¨è€…è³‡è¨Š
- `DELETE /{user_id}`: åˆªé™¤æŒ‡å®šä½¿ç”¨è€…
- `POST /{user_id}/role`: åˆ†é…ä½¿ç”¨è€…è§’è‰²
- `POST /{user_id}/status`: æ›´æ”¹ç”¨æˆ¶ç‹€æ…‹
- `POST /{user_id}/activate`: å•Ÿç”¨ç”¨æˆ¶
- `POST /{user_id}/deactivate`: åœç”¨ç”¨æˆ¶

#### è§’è‰²èˆ‡ç‹€æ…‹æŸ¥è©¢ APIï¼ˆå·²èªè­‰ç”¨æˆ¶å¯ç”¨ï¼‰
- `GET /role/{role}`: ç²å–æŒ‡å®šè§’è‰²ç”¨æˆ¶
- `GET /status/{status}`: ç²å–æŒ‡å®šç‹€æ…‹ç”¨æˆ¶

#### ç”¨æˆ¶é—œä¿‚ç®¡ç† APIï¼ˆå·²èªè­‰ç”¨æˆ¶å¯ç”¨ï¼‰
- `GET /{user_id}/linked-accounts`: æŸ¥çœ‹é€£çµçš„ç¬¬ä¸‰æ–¹å¸³è™Ÿ
- `POST /{user_id}/send-verification`: ç™¼é€é©—è­‰ä¿¡
- `POST /{user_id}/reset-password`: é‡ç½®å¯†ç¢¼

---

### ğŸ” èªè­‰èˆ‡å®‰å…¨ (`app/auth.py`)

#### å¯†ç¢¼è™•ç†
- `verify_password(plain_password, hashed_password)`: é©—è­‰å¯†ç¢¼
- `get_password_hash(password)`: å¯†ç¢¼å“ˆå¸ŒåŠ å¯†

#### ä½¿ç”¨è€…é©—è­‰
- `get_user(db, username)`: æ ¹æ“šä½¿ç”¨è€…åç¨±ç²å–ä½¿ç”¨è€…
- `authenticate_user(db, username, password)`: é©—è­‰ä½¿ç”¨è€…èº«ä»½

#### JWT ä»¤ç‰Œ
- `create_access_token(data, expires_delta)`: å»ºç«‹ JWT è¨ªå•ä»¤ç‰Œ

#### ä¾è³´é …å‡½æ•¸
- `get_current_user(token, db)`: å¾ä»¤ç‰Œç²å–ç•¶å‰ä½¿ç”¨è€…
- `get_current_active_user(current_user)`: ç²å–ç•¶å‰æ´»èºä½¿ç”¨è€…
- `get_admin_user(current_user)`: ç²å–ç®¡ç†å“¡ä½¿ç”¨è€…ï¼ˆæ¬Šé™æª¢æŸ¥ï¼‰

#### å…¨åŸŸé…ç½®
- `pwd_context`: å¯†ç¢¼åŠ å¯†ä¸Šä¸‹æ–‡
- `oauth2_scheme`: OAuth2 Bearer èªè­‰æ–¹æ¡ˆ

---

### âš™ï¸ æ‡‰ç”¨ç¨‹å¼é…ç½® (`app/core/config.py`)

#### `Settings` é¡
æ‡‰ç”¨ç¨‹å¼çš„çµ„æ…‹è¨­å®šé¡ï¼ŒåŒ…å«ï¼š

##### è³‡æ–™åº«è¨­å®š
- `DATABASE_URL`: è³‡æ–™åº«é€£æ¥ URL

##### JWT è¨­å®š
- `SECRET_KEY`: JWT é‡‘é‘°
- `ALGORITHM`: åŠ å¯†æ¼”ç®—æ³•
- `ACCESS_TOKEN_EXPIRE_MINUTES`: ä»¤ç‰ŒéæœŸæ™‚é–“

##### æ‡‰ç”¨è¨­å®š
- `APP_NAME`: æ‡‰ç”¨ç¨‹å¼åç¨±
- `APP_VERSION`: ç‰ˆæœ¬è™Ÿ
- `DEBUG`: é™¤éŒ¯æ¨¡å¼
- `ENVIRONMENT`: é‹è¡Œç’°å¢ƒ

##### å®‰å…¨è¨­å®š
- `ALLOWED_HOSTS`: å…è¨±çš„ä¸»æ©Ÿåˆ—è¡¨

##### åˆ†é è¨­å®š
- `DEFAULT_PAGE_SIZE`: é è¨­åˆ†é å¤§å°
- `MAX_PAGE_SIZE`: æœ€å¤§åˆ†é å¤§å°

##### å¯†ç¢¼è¨­å®š
- `MIN_PASSWORD_LENGTH`: æœ€å°å¯†ç¢¼é•·åº¦

**å…¨åŸŸå¯¦ä¾‹**: `settings` - å¯ç›´æ¥ä½¿ç”¨çš„è¨­å®šå¯¦ä¾‹

---

### ğŸ—ƒï¸ è³‡æ–™åº«é…ç½® (`app/database.py`)

#### æ ¸å¿ƒåŠŸèƒ½
- `engine`: SQLAlchemy è³‡æ–™åº«å¼•æ“
- `SessionLocal`: è³‡æ–™åº«æœƒè©±å·¥å» 
- `Base`: SQLAlchemy åŸºç¤æ¨¡å‹é¡

#### å‡½æ•¸
- `get_db()`: è³‡æ–™åº«æœƒè©±ä¾è³´é …ï¼ˆç”¢ç”Ÿå™¨ï¼‰
- `create_tables()`: å»ºç«‹è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è¡¨

#### ç’°å¢ƒæ”¯æ´
- æ”¯æ´æ¸¬è©¦ç’°å¢ƒï¼ˆSQLiteï¼‰å’Œç”Ÿç”¢ç’°å¢ƒè³‡æ–™åº«åˆ‡æ›

---

### ğŸš€ ä¸»æ‡‰ç”¨ç¨‹å¼ (`main.py`)

#### `app` (FastAPI å¯¦ä¾‹)
ä¸»è¦çš„ FastAPI æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹

#### åŠŸèƒ½é…ç½®
- **CORS ä¸­é–“ä»¶**: è·¨åŸŸè«‹æ±‚æ”¯æ´
- **è·¯ç”±è¨»å†Š**: ä½¿ç”¨è€…ç›¸é—œè·¯ç”± (`/users`)
- **æ¨™ç±¤ç®¡ç†**: API æ–‡ä»¶åˆ†çµ„

#### åŸºç¤ç«¯é»
- `GET /`: æ ¹ç›®éŒ„ï¼ŒAPI åŸºæœ¬è³‡è¨Š
- `GET /health`: å¥åº·æª¢æŸ¥ç«¯é»

---

## ğŸ¯ å¿«é€Ÿä½¿ç”¨æŒ‡å—

### æª¢æŸ¥åŠŸèƒ½æ˜¯å¦å­˜åœ¨
1. **ä½¿ç”¨è€…ç®¡ç†**: æŸ¥çœ‹ `UserCRUD` é¡çš„æ–¹æ³•
2. **API ç«¯é»**: æŸ¥çœ‹ `app/routers/users.py` çš„è·¯ç”±
3. **è³‡æ–™é©—è­‰**: æŸ¥çœ‹ `app/schemas/user_schemas.py` çš„æ¨¡å‹
4. **èªè­‰åŠŸèƒ½**: æŸ¥çœ‹ `app/auth.py` çš„å‡½æ•¸

### æ–°å¢åŠŸèƒ½å‰çš„æª¢æŸ¥æ¸…å–®
- [ ] æª¢æŸ¥ `UserCRUD` æ˜¯å¦å·²æœ‰ç›¸é—œçš„è³‡æ–™åº«æ“ä½œæ–¹æ³•
- [ ] æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸æ‡‰çš„ Pydantic é©—è­‰æ¨¡å‹
- [ ] æª¢æŸ¥è·¯ç”±æ˜¯å¦å·²å­˜åœ¨é¡ä¼¼çš„ç«¯é»
- [ ] æª¢æŸ¥èªè­‰/æˆæ¬Šæ˜¯å¦æ»¿è¶³éœ€æ±‚

---

## ğŸ“Š åŠŸèƒ½çµ±è¨ˆ

- **è³‡æ–™åº«æ¨¡å‹**: 1 å€‹ä¸»è¦æ¨¡å‹ + 1 å€‹æšèˆ‰
- **è³‡æ–™é©—è­‰æ¨¡å‹**: 11 å€‹ Pydantic æ¨¡å‹
- **CRUD æ–¹æ³•**: 16 å€‹è³‡æ–™åº«æ“ä½œæ–¹æ³•
- **API ç«¯é»**: 19 å€‹ REST API ç«¯é»
- **èªè­‰å‡½æ•¸**: 7 å€‹èªè­‰ç›¸é—œå‡½æ•¸
- **é…ç½®é …ç›®**: 13 å€‹æ‡‰ç”¨ç¨‹å¼è¨­å®š

### ğŸ¯ API ç«¯é»åˆ†é¡çµ±è¨ˆ
- **èªè­‰ç›¸é—œ**: 2 å€‹ç«¯é»
- **å€‹äººè³‡æ–™**: 4 å€‹ç«¯é»
- **ç®¡ç†å“¡å°ˆç”¨**: 9 å€‹ç«¯é»
- **å·²èªè­‰ç”¨æˆ¶**: 4 å€‹ç«¯é»

### ğŸ” æ¬Šé™å±¤ç´šèªªæ˜
1. **ç„¡éœ€èªè­‰**: è¨»å†Šã€ç™»å…¥
2. **éœ€è¦èªè­‰**: å€‹äººè³‡æ–™ç®¡ç†ã€æŸ¥è©¢åŠŸèƒ½
3. **ç®¡ç†å“¡æ¬Šé™**: ç³»çµ±ç®¡ç†ã€ç”¨æˆ¶ç®¡ç†ã€çµ±è¨ˆè³‡è¨Š

---

*æœ€å¾Œæ›´æ–°: 2025-07-16 - ç§»é™¤éå¿…è¦APIç«¯é»ï¼Œç°¡åŒ–ç³»çµ±æ¶æ§‹*
*ç¶­è­·è€…: é–‹ç™¼åœ˜éšŠ*

---

## ğŸ”„ æ›´æ–°æ—¥èªŒ

### v1.2.0 (2025-07-16)
- âœ… ç§»é™¤éå¿…è¦çš„ API ç«¯é» (stylists, customers, admins, search, filter, stats)
- âœ… æ¸…ç†ç›¸é—œçš„ CRUD æ–¹æ³•å’Œ Schema æ¨¡å‹
- âœ… ç°¡åŒ–ç³»çµ±æ¶æ§‹ï¼Œä¿ç•™æ ¸å¿ƒåŠŸèƒ½
- âœ… æ›´æ–°æ–‡æª”å’ŒåŠŸèƒ½å°èˆª

### v1.1.0 (2025-07-16)
- âœ… æ–°å¢ 14 å€‹ API ç«¯é»
- âœ… å¯¦ç¾ä¸‰å±¤æ¬Šé™æ§åˆ¶ç³»çµ±
- âœ… æ–°å¢è§’è‰²èˆ‡ç‹€æ…‹æŸ¥è©¢åŠŸèƒ½
- âœ… æ–°å¢ç”¨æˆ¶æœå°‹èˆ‡ç¯©é¸åŠŸèƒ½
- âœ… æ–°å¢é€²éšç”¨æˆ¶ç®¡ç†åŠŸèƒ½
- âœ… æ–°å¢ç”¨æˆ¶é—œä¿‚ç®¡ç†åŠŸèƒ½
- âœ… å„ªåŒ–æ¬Šé™åˆ†é…å’Œå®‰å…¨æ€§
- âœ… æ›´æ–°æ–‡æª”å’ŒåŠŸèƒ½å°èˆª

### v1.0.0 (2024-07-15)
- âœ… åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒ
- âœ… åŸºç¤ç”¨æˆ¶ç®¡ç†ç³»çµ±
- âœ… JWT èªè­‰æ©Ÿåˆ¶
- âœ… CRUD æ¶æ§‹å»ºç«‹ 